name: Build and Deploy

on:
  push:
    branches:
      - mainx

env:
  IMAGE_NAME: ghcr.io/resolve-io/resolve-onboarding
  DEPLOY_HOST: ec2-54-147-199-139.compute-1.amazonaws.com
  DEPLOY_USER: ec2-user
  # Supabase DATABASE_URL should be stored as a secret in GitHub

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        run: echo "${{ secrets.ONBOARDING_GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: docker build --target production -t ${{ env.IMAGE_NAME }}:latest .

      - name: Push Docker image to GHCR
        run: docker push ${{ env.IMAGE_NAME }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: SSH into internal host and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_ONBOARDING_SSH_KEY }}
          script: |
            IMAGE_NAME=ghcr.io/resolve-io/resolve-onboarding
            echo "${{ secrets.ONBOARDING_GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            cd /opt/onboarding
            
            # Pull the latest app image
            docker pull $IMAGE_NAME:latest
            docker tag $IMAGE_NAME:latest onboarding_app:latest
            
            # Stop ALL containers and clean up completely
            docker-compose down --remove-orphans || true
            docker stop $(docker ps -q) 2>/dev/null || true
            
            # Backup and recreate docker-compose.yml
            sudo cp docker-compose.yml docker-compose.yml.bak 2>/dev/null || true
            
            # Create simple docker-compose.yml with ONLY the app
            echo 'services:
              app:
                image: onboarding_app:latest
                ports:
                  - "80:5000"
                  - "5000:5000"
                environment:
                  - NODE_ENV=production
                  - PORT=5000
                volumes:
                  - ./uploads:/app/uploads
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
                  interval: 30s
                  timeout: 3s
                  retries: 3
                  start_period: 10s
                restart: unless-stopped' | sudo tee docker-compose.yml > /dev/null
            
            # Start the app container
            docker-compose up -d
            
            # Wait for app to be ready
            echo "Waiting for application to start..."
            sleep 10
            
            # Database operations commented out - migrations run automatically on app startup
            # echo "Running database migrations on Supabase..."
            # docker-compose exec -T app sh -c "node scripts/migrate-supabase.js || echo 'Migration completed with warnings'"
            
            # # Create admin user in Supabase database
            # echo "Ensuring admin@resolve.io user exists in Supabase..."
            # docker-compose exec -T app sh -c "npm install bcryptjs && node scripts/create-admin.js"
            
            # # Verify Supabase pgvector support
            # echo "Checking Supabase pgvector support..."
            # docker-compose exec -T app sh -c "node -e \"
            #   const { Pool } = require('pg');
            #   const pool = new Pool({ connectionString: process.env.DATABASE_URL });
            #   
            #   (async () => {
            #     try {
            #       // Check if vector extension exists
            #       const result = await pool.query(\\\"SELECT * FROM pg_extension WHERE extname = 'vector'\\\");
            #       if (result.rows.length > 0) {
            #         console.log('✅ pgvector is available in Supabase (version ' + result.rows[0].extversion + ')');
            #       } else {
            #         console.log('⚠️  pgvector extension not enabled. Enable it in Supabase dashboard.');
            #       }
            #     } catch (error) {
            #       console.error('Could not check pgvector:', error.message);
            #     } finally {
            #       await pool.end();
            #     }
            #   })();
            # \""
            
            # Verify deployment
            echo "Deployment complete. Checking application health..."
            sleep 5
            if curl -f http://localhost:5000/health; then
              echo "✅ Application is healthy and connected to Supabase!"
            else
              echo "⚠️  Health check failed. Checking logs..."
              docker-compose logs --tail=50 app
            fi
