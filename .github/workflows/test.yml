name: Type Check & Unit Tests

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '*.txt'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install root dependencies
      run: npm install

    - name: Install package dependencies
      run: |
        cd packages/api-server && npm ci --legacy-peer-deps
        cd ../client && npm ci --legacy-peer-deps
        cd ../mock-service && npm ci --legacy-peer-deps

    - name: Type check (all packages)
      run: npm run type-check

    - name: Lint (all packages)
      run: npm run lint

    - name: Run API server unit tests
      run: |
        cd packages/api-server
        npm run test:run

    - name: Run client unit tests
      run: |
        cd packages/client
        npm run test:unit

    # E2E tests temporarily disabled - no E2E tests currently implemented
    # - name: Install Playwright browsers
    #   run: cd packages/client && npx playwright install --with-deps chromium

    # - name: Start infrastructure services
    #   run: |
    #     docker compose up -d

    #     # Wait for infrastructure services to be healthy
    #     echo "Waiting for infrastructure services..."
    #     for i in {1..60}; do
    #       if docker compose ps | grep -E "(postgres|rabbitmq|redis|keycloak)" | grep -q "(healthy)"; then
    #         echo "✅ Infrastructure services are healthy"
    #         break
    #       fi
    #       echo "Waiting for services... ($i/60)"
    #       sleep 3
    #     done

    #     # Show service status
    #     docker compose ps

    # - name: Start API server
    #   run: |
    #     cd packages/api-server
    #     npm run build
    #     npm start &

    #     # Wait for API server to be ready
    #     echo "Waiting for API server..."
    #     for i in {1..30}; do
    #       if curl -s http://localhost:3000/health > /dev/null; then
    #         echo "✅ API server is ready"
    #         break
    #       fi
    #       echo "Waiting for API server... ($i/30)"
    #       sleep 2
    #     done
    #   env:
    #     NODE_ENV: test
    #     DATABASE_URL: postgresql://rita:rita@localhost:5432/onboarding

    # - name: Start client (if needed for E2E)
    #   run: |
    #     cd packages/client
    #     npm run build
    #     npm run preview &

    #     # Wait for client to be ready
    #     echo "Waiting for client..."
    #     for i in {1..30}; do
    #       if curl -s http://localhost:5173 > /dev/null; then
    #         echo "✅ Client is ready"
    #         break
    #       fi
    #       echo "Waiting for client... ($i/30)"
    #       sleep 2
    #     done

    # - name: Run E2E tests (RITA Go)
    #   run: npm test
    #   env:
    #     CI: true

    # - name: Upload test results
    #   uses: actions/upload-artifact@v4
    #   if: always()
    #   with:
    #     name: playwright-report
    #     path: packages/client/playwright-report/
    #     retention-days: 30

    # - name: Stop services
    #   if: always()
    #   run: docker compose down -v
